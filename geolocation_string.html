
<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>ã€ç¤¾å¤–ã€‘ç¾åœ¨åœ°</title>
 <script src="js/BmapQuery.js"></script>
 <script  src="./js/seat.js"></script>
 <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
 <script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AiLSgEp6EKsKqhq1MVQJPDYNhvhy2HfpP6nWLKJZVj8SlU5qqvseYmirt-9bH7Vv' async
   defer></script>
 <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>ç¾åœ¨åœ°ã®ç™»éŒ²</h1>
  <div>
    <div class="name"> åå‰ï¼š<input type="text" id="uname"> </div>
    <div class="btn">
    <button  class="btn_set" id="geo">ç¾åœ¨åœ°ã‚’èª­ã¿è¾¼ã‚€</button>
    <button class="btn_set" id="geo_set">ç™»éŒ²</button>
  </div>
  </div>

  <!-- MapArea -->
  <div id="view"></div>
  <div id="myMap" style="width:100%;height:100%;"></div>

  <!-- ç™»éŒ²ä½ç½®æƒ…å ±ã®è¡¨ç¤º -->
  <p>éå»ã®ç™»éŒ²å±¥æ­´</p>
  <table class="midashi">
    <tr>
      <th>ç™»éŒ²æ—¥</th>
      <th>åå‰</th>
      <th>ç·¯åº¦</th>
      <th>è»½åº¦</th>
    </tr>
  </table>
  <div id="output"></div>
  
  <button class="back" onclick="location.href='index.html'">æˆ»ã‚‹ </button>

<!-- Firebase -->
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
// è²¼ã‚Šä»˜ã‘ã‚‹å ´æ‰€
import { getDatabase, ref, push,set, onChildAdded, remove, onChildRemoved , serverTimestamp} from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
//

// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {

};


// Initialize Firebase
const app = initializeApp(firebaseConfig);

const db = getDatabase(app);
const dbRef = ref(db, '05-js-kadai');

// ç™»éŒ²
$('#geo_set').on('click', function () {
  const lat = localStorage.getItem("centerLatitude");
  const lon = localStorage.getItem("centerLongitude");
  const time = localStorage.getItem("time");
  const uname = $('#uname').val();

  const geo_data = {
  uname: uname,
  lat: lat,
  lon: lon,
  time: time,
}


// firebaseã«é€ã‚‹æº–å‚™ã‚’ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ğŸ¤—
const newPostRef = push(dbRef) //ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã§ãã‚‹æº–å‚™
set(newPostRef, geo_data); // firebaseã®ç™»éŒ²ã§ãã‚‹å ´æ‰€ã«ä¿å­˜ã™ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ğŸ¤—

});

// å—ä¿¡å‡¦ç†ã‚’è¨˜è¿°
onChildAdded(dbRef, function (data) {
// ã“ã“ã‹ã‚‰ãŒå—ä¿¡å‡¦ç†ãŒå§‹ã¾ã‚Šã¾ã™

// ç™»éŒ²ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ğŸ¤—
const geo_data = data.val();
console.log(geo_data, 'å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®å¡Š')
const key = data.key;
console.log(key, 'ãƒ‡ãƒ¼ã‚¿ã®å¡Šã«ã‚¢ã‚¯ã‚»ã‚¹')

// es6ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªãƒ†ãƒ©ãƒ«
let h = `
        <tr>
          <th>${Date(geo_data.time).slice(4, 25)}</th>
          <td>${geo_data.uname}</td>
          <td>${geo_data.lat}</td>
          <td>${geo_data.lon}</td>
          <td><button class="clear" data-a=${key}>å‰Šé™¤</button></td>
        </tr>
`;

// htmlã«åŸ‹ã‚è¾¼ã¿ã¾ã—ã‚‡ã†ğŸ¤—
// append();ã¨ã„ã†jqueryã®ãŠã¾ã˜ãªã„ã‚’ä½¿ã„ã¾ã™
$("#output").append(h);
});

// å‰Šé™¤ã‚’ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰â‡¨ã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã‚Œã°æˆåŠŸï¼ï¼
$(document).on("click", ".clear", function () {
  let v = $(this).data("a");
  //  console.log(v, "ãŠã‚„");
  //  let aa = $(this).data("a"); //data-a data-ã¯çœç•¥ã™ã‚‹ã®ã§ã€€ã€Œaã€
   console.log(v, "ã‚«ã‚®");
  remove(ref(db, "05-js-kadai/" + v));
  location.reload(); // jsã®ãŠã¾ã˜ãªã„ã€æœ¬æ¥ã¯firebaseå´ã« onChildRemoved
});

</script>
</body>
</html>